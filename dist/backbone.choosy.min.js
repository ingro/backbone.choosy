"use strict";function _inherits(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function, not "+typeof o);e.prototype=Object.create(o&&o.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),o&&(e.__proto__=o)}function _classCallCheck(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}var _get=function(e,o,t){for(var n=!0;n;){var s=e,i=o,c=t;l=r=h=void 0,n=!1,null===s&&(s=Function.prototype);var l=Object.getOwnPropertyDescriptor(s,i);if(void 0!==l){if("value"in l)return l.value;var h=l.get;return void 0===h?void 0:h.call(c)}var r=Object.getPrototypeOf(s);if(null===r)return void 0;e=r,o=i,t=c,n=!0}},_createClass=function(){function e(e,o){for(var t=0;t<o.length;t++){var n=o[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(o,t,n){return t&&e(o.prototype,t),n&&e(o,n),o}}();!function(e){"function"==typeof define&&define.amd?define(["underscore","backbone"],e):"undefined"!=typeof module&&module.exports?module.exports=e(require("underscore"),require("backbone")):e(_,Backbone)}(function(e,o){var t=function(){function o(t){var n=this;_classCallCheck(this,o),this.model=t,this.model._chooser=this,this.modelSave=this.model.save,e.each(this._publicMethoods(),function(o){n.model[o]=e.bind(n[o],n)}),this.chosen=!1,this.model.set("_chosen",!1)}return _createClass(o,[{key:"save",value:function t(e){var o=void 0===arguments[1]?{}:arguments[1],n=this.model.attributes._chosen;delete this.model.attributes._chosen;var t=this.modelSave.call(this.model,e,o);return this.model.attributes._chosen=n,t}},{key:"_publicMethoods",value:function(){return["choose","unchoose","toggleChoose","isChosen","save"]}},{key:"isChosen",value:function(){return!!this.chosen}},{key:"choose",value:function(){var e=void 0===arguments[0]?{}:arguments[0];this.isChosen()||(this.chosen=!0,this.model.set("_chosen",!0,e),1!=e.silent&&this.model.trigger("model:chosen",this.model),null!=this.model.collection&&"function"==typeof this.model.collection.choose&&this.model.collection.choose(this.model,e))}},{key:"unchoose",value:function(){var e=void 0===arguments[0]?{}:arguments[0];this.isChosen()&&(this.chosen=!1,this.model.set("_chosen",!1,e),1!=e.silent&&this.model.trigger("model:unchosen",this.model),null!=this.model.collection&&"function"==typeof this.model.collection.unchoose&&this.model.collection.unchoose(this.model,e))}},{key:"toggleChoose",value:function(){this.isChosen()?this.unchoose():this.choose()}}]),o}(),n=function(){function o(t){var n=this;_classCallCheck(this,o),this.collection=t,this.collection._chooser=this,this.collection._chooser.chosen={},e.each(this._publicMethoods(),function(o){n.collection[o]=e.bind(n[o],n)})}return _createClass(o,[{key:"_publicMethoods",value:function(){return["choose","unchoose","getChosen","getFirstChosen","chooseById","chooseNone"]}},{key:"getChosen",value:function(){return e.toArray(this.chosen)}},{key:"getFirstChosen",value:function(){return this.getChosen()[0]}},{key:"modelInChosen",value:function(o){return e.contains(e.keys(this.chosen),o.cid)}},{key:"chooseNone",value:function(){var e=void 0===arguments[0]?{}:arguments[0];0!==this.getChosen().length&&(this.removeModels(),this.triggerEvent(!1,e))}},{key:"addModel",value:function(e){var o=void 0===arguments[1]?{}:arguments[1];this.chosen[e.cid]=e,e.choose&&e.choose(o)}},{key:"removeModels",value:function(){var o=this,t=void 0===arguments[0]?!1:arguments[0],n=t?t:this.getChosen();e.each(e.flatten([n]),function(e){delete o.chosen[e.cid],e.unchoose&&e.unchoose()})}},{key:"triggerEvent",value:function(){var o=void 0===arguments[0]?!1:arguments[0],t=void 0===arguments[1]?{}:arguments[1];e.defaults(t,{silent:!1}),t.silent!==!0&&(o||(o=this._getEvent()),this.collection.trigger(o,this._eventArg()))}},{key:"chooseById",value:function(e){var o=void 0===arguments[1]?{}:arguments[1],t=this.collection.get(e);t&&this.choose(t,o)}}]),o}(),s=function(e){function o(){_classCallCheck(this,o),_get(Object.getPrototypeOf(o.prototype),"constructor",this).apply(this,arguments)}return _inherits(o,e),_createClass(o,[{key:"_eventArg",value:function(){return this.getFirstChosen()}},{key:"choose",value:function(e,o){this.modelInChosen(e)||(this.removeModels(),this.addModel(e),this.triggerEvent("collection:choose:one",o))}},{key:"unchoose",value:function(e,o){this.modelInChosen(e)&&(this.removeModels(e),this.triggerEvent("collection:unchoose:one",o))}},{key:"_getEvent",value:function(){return 0===this.getChosen().length?"collection:unchoose:one":"collection:choose:one"}}]),o}(n),i=function(t){function n(o){var t=this;_classCallCheck(this,n),_get(Object.getPrototypeOf(n.prototype),"constructor",this).call(this,o);var s=["chooseAll","chooseByIds"];e.each(s,function(o){t.collection[o]=e.bind(t[o],t)})}return _inherits(n,t),_createClass(n,[{key:"_eventArg",value:function(){return this.getChosen()}},{key:"choose",value:function(){for(var t=this,n=arguments.length,s=Array(n),i=0;n>i;i++)s[i]=arguments[i];var c=e.chain(s).flatten().last().value()instanceof o.Model?{}:s.pop(),l=!1;e.each(e.chain([s]).flatten().value(),function(e){return t.modelInChosen(e)?!0:(l||(l=!0),void t.addModel(e,c))}),l&&this.triggerEvent(!1,c)}},{key:"unchoose",value:function(){for(var t=this,n=arguments.length,s=Array(n),i=0;n>i;i++)s[i]=arguments[i];var c=e.chain(s).flatten().last().value()instanceof o.Model?{}:s.pop(),l=!1;e.each(e.chain([s]).flatten().value(),function(e){return t.modelInChosen(e)?(l||(l=!0),void t.removeModels(e,c)):!0}),l&&this.triggerEvent(!1,c)}},{key:"chooseAll",value:function(){var o=this,t=void 0===arguments[0]?{}:arguments[0];e.difference(this.collection.models,this.getChosen()).length&&(e.each(this.collection.models,function(e){o.addModel(e)}),this.triggerEvent(!1,t))}},{key:"chooseByIds",value:function(){var o=this,t=void 0===arguments[0]?[]:arguments[0],n=void 0===arguments[1]?{}:arguments[1];e.defaults(n,{chooseNone:!0}),n.chooseNone&&this.chooseNone(n),e.each(e.chain([t]).flatten().value(),function(e){o.chooseById(e,n)})}},{key:"_getEvent",value:function(){return 0===this.getChosen().length?"collection:chose:none":this.collection.length===this.getChosen().length?"collection:chose:all":"collection:chose:some"}}]),n}(n);return o.Choosy=t,o.SingleChooser=s,o.MultiChooser=i,o.Choosy});